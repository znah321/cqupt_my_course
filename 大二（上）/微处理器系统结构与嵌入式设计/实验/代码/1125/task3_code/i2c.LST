C51 COMPILER V9.60.0.0   I2C                                                               12/08/2020 19:06:51 PAGE 1   


C51 COMPILER V9.60.0.0, COMPILATION OF MODULE I2C
OBJECT MODULE PLACED IN i2c.OBJ
COMPILER INVOKED BY: C:\Keil_v5\C51\BIN\C51.EXE i2c.c OPTIMIZE(8,SPEED) BROWSE DEBUG OBJECTEXTEND TABS(2)

line level    source

   1          #include"i2c.h"
   2          
   3          /*******************************************************************************
   4          * 函 数 名         : Delay1us()
   5          * 函数功能       : 延时
   6          * 输    入         : 无
   7          * 输    出         : 无
   8          *******************************************************************************/
   9          
  10          void I2C_Delay10us()
  11          {
  12   1        uchar a, b;
  13   1        for(b=1; b>0; b--)
  14   1        {
  15   2          for(a=2; a>0; a--);
  16   2        }
  17   1      }
  18          /*******************************************************************************
  19          * 函 数 名         : I2C_Start()
  20          * 函数功能       : 起始信号：在I2C_SCL时钟信号在高电平期间I2C_SDA信号产生一个下降沿
  21          * 输    入         : 无
  22          * 输    出         : 无
  23          * 备    注         : 起始之后I2C_SDA和I2C_SCL都为0
  24          *******************************************************************************/
  25          
  26          void I2C_Start()
  27          {
  28   1        I2C_SDA = 1;
  29   1        I2C_Delay10us();
  30   1        I2C_SCL = 1;
  31   1        I2C_Delay10us();//建立时间是I2C_SDA保持时间>4.7us
  32   1        I2C_SDA = 0;
  33   1        I2C_Delay10us();//保持时间是>4us
  34   1        I2C_SCL = 0;      
  35   1        I2C_Delay10us();    
  36   1      }
  37          /*******************************************************************************
  38          * 函 数 名           : I2C_Stop()
  39          * 函数功能           : 终止信号：在I2C_SCL时钟信号高电平期间I2C_SDA信号产生一个上升沿
  40          * 输    入           : 无
  41          * 输    出           : 无
  42          * 备    注           : 结束之后保持I2C_SDA和I2C_SCL都为1；表示总线空闲
  43          *******************************************************************************/
  44          
  45          void I2C_Stop()
  46          {
  47   1        I2C_SDA = 0;
  48   1        I2C_Delay10us();
  49   1        I2C_SCL = 1;
  50   1        I2C_Delay10us();//建立时间大于4.7us
  51   1        I2C_SDA = 1;
  52   1        I2C_Delay10us();    
  53   1      }
  54          /*******************************************************************************
  55          * 函 数 名           : I2cSendByte(uchar num)
C51 COMPILER V9.60.0.0   I2C                                                               12/08/2020 19:06:51 PAGE 2   

  56          * 函数功能           : 通过I2C发送一个字节。在I2C_SCL时钟信号高电平期间，
  57          *                    * 保持发送信号I2C_SDA保持稳定
  58          * 输    入           : num ,ack
  59          * 输    出           : 0或1。发送成功返回1，发送失败返回0
  60          * 备    注           : 发送完一个字节I2C_SCL=0, 需要应答则应答设置为1，否则为0
  61          *******************************************************************************/
  62          
  63          uchar I2C_SendByte(uchar dat, uchar ack)
  64          {
  65   1        uchar a = 0,b = 0;//最大255，一个机器周期为1us，最大延时255us。
  66   1            
  67   1        for(a=0; a<8; a++)//要发送8位，从最高位开始
  68   1        {
  69   2          I2C_SDA = dat >> 7;  //起始信号之后I2C_SCL=0，所以可以直接改变I2C_SDA信号
  70   2          dat = dat << 1;
  71   2          I2C_Delay10us();
  72   2          I2C_SCL = 1;
  73   2          I2C_Delay10us();//建立时间>4.7us
  74   2          I2C_SCL = 0;
  75   2          I2C_Delay10us();//时间大于4us   
  76   2        }
  77   1      
  78   1        I2C_SDA = 1;
  79   1        I2C_Delay10us();
  80   1        I2C_SCL = 1;
  81   1        while(I2C_SDA && (ack == 1))//等待应答，也就是等待从设备把I2C_SDA拉低
  82   1        {
  83   2          b++;
  84   2          if(b > 200)  //如果超过200us没有应答发送失败，或者为非应答，表示接收结束
  85   2          {
  86   3            I2C_SCL = 0;
  87   3            I2C_Delay10us();
  88   3            return 0;
  89   3          }
  90   2        }
  91   1      
  92   1        I2C_SCL = 0;
  93   1        I2C_Delay10us();
  94   1        return 1;   
  95   1      }
  96          /*******************************************************************************
  97          * 函 数 名           : I2cReadByte()
  98          * 函数功能         : 使用I2c读取一个字节
  99          * 输    入           : 无
 100          * 输    出           : dat
 101          * 备    注           : 接收完一个字节I2C_SCL=0
 102          *******************************************************************************/
 103          
 104          uchar I2C_ReadByte()
 105          {
 106   1        uchar a = 0,dat = 0;
 107   1        I2C_SDA = 1;      //起始和发送一个字节之后I2C_SCL都是0
 108   1        I2C_Delay10us();
 109   1        for(a=0; a<8; a++)//接收8个字节
 110   1        {
 111   2          I2C_SCL = 1;
 112   2          I2C_Delay10us();
 113   2          dat <<= 1;
 114   2          dat |= I2C_SDA;
 115   2          I2C_Delay10us();
 116   2          I2C_SCL = 0;
 117   2          I2C_Delay10us();
C51 COMPILER V9.60.0.0   I2C                                                               12/08/2020 19:06:51 PAGE 3   

 118   2        }
 119   1        return dat;   
 120   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    193    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =   ----    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
